<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Love Points â¤ï¸</title>
  
  <!-- 1. è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. è¼‰å…¥ Babel (è®“ç€è¦½å™¨çœ‹å¾—æ‡‚ React) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- è¨­å®š Tailwind å‹•ç•« -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'bounce-slow': 'bounce 3s infinite',
          }
        }
      }
    }
  </script>
  <style>
    /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    body { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-rose-50 text-slate-800">

  <div id="root"></div>

  <!-- 3. React ä¸»ç¨‹å¼ -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    
    // Firebase Imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { 
      getAuth, 
      signInAnonymously, 
      onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      onSnapshot, 
      doc, 
      updateDoc, 
      serverTimestamp, 
      deleteDoc,
      setDoc,
      increment,
      getDocs
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // --- å¦³çš„ Firebase é‡‘é‘° ---
    const firebaseConfig = {
      apiKey: "AIzaSyBAizT0ijN3-uxegV4w2HX6VFvXvYndc3c",
      authDomain: "change-389a0.firebaseapp.com",
      projectId: "change-389a0",
      storageBucket: "change-389a0.firebasestorage.app",
      messagingSenderId: "360528719647",
      appId: "1:360528719647:web:474055ac8fb26e370c0a2a"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const DATA_COLLECTION = "love_points_data_v1";

    // --- ç°¡æ˜“åœ–ç¤ºå…ƒä»¶ (å› ç‚º CDN è¼‰å…¥åœ–ç¤ºåº«æ¯”è¼ƒæ…¢ï¼Œç›´æ¥ç”¨ SVG æœ€å¿«) ---
    const Icon = ({ name, size = 24, className = "" }) => {
      const icons = {
        Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
        Camera: <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>,
        Gift: <rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/>,
        Bell: <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>,
        Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>,
        LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>,
        CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>,
        Plus: <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>,
        Trash2: <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>,
        Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/>,
        Clock: <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>,
        XCircle: <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>,
        ChevronRight: <path d="m9 18 6-6-6-6"/>
      };
      return (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width={size} 
          height={size} 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round" 
          className={className}
        >
          {icons[name] || null}
        </svg>
      );
    };

    // --- åœ–ç‰‡å£“ç¸®å·¥å…· ---
    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 600; 
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.6));
          };
        };
      });
    };

    // --- ä¸»ç¨‹å¼å…ƒä»¶ ---
    function App() {
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [isAdmin, setIsAdmin] = useState(false);
      const [points, setPoints] = useState(0);
      const [submissions, setSubmissions] = useState([]);
      const [rewards, setRewards] = useState([]);
      const [notifications, setNotifications] = useState([]);
      const [loading, setLoading] = useState(true);
      const [unreadCount, setUnreadCount] = useState(0);

      const [desc, setDesc] = useState('');
      const [selectedFile, setSelectedFile] = useState(null);
      const [isUploading, setIsUploading] = useState(false);
      
      const [wishName, setWishName] = useState('');
      const [wishImage, setWishImage] = useState(null);
      const [showWishForm, setShowWishForm] = useState(false);
      const [pricingId, setPricingId] = useState(null);
      const [pricingCost, setPricingCost] = useState('');
      
      const [adminPass, setAdminPass] = useState('');
      const [showAdminLogin, setShowAdminLogin] = useState(false);

      // åˆå§‹åŒ–
      useEffect(() => {
        const init = async () => {
          try {
            await signInAnonymously(auth);
            if ("Notification" in window && Notification.permission === "default") {
              Notification.requestPermission();
            }
          } catch (e) { console.error("Auth Error", e); }
        };
        init();
        const unsub = onAuthStateChanged(auth, (u) => {
          setUser(u);
          if (u) setLoading(false);
        });
        return () => unsub();
      }, []);

      // æ•¸æ“šç›£è½
      useEffect(() => {
        if (!user) return;
        const statsRef = doc(db, DATA_COLLECTION, 'stats');
        const unsubStats = onSnapshot(statsRef, (s) => {
          if (s.exists()) setPoints(s.data().totalPoints || 0);
          else setDoc(statsRef, { totalPoints: 0 });
        });
        const unsubSubs = onSnapshot(collection(db, DATA_COLLECTION, 'submissions'), (s) => {
          const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
          data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
          setSubmissions(data);
        });
        const unsubRewards = onSnapshot(collection(db, DATA_COLLECTION, 'rewards'), (s) => {
          const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
          data.sort((a, b) => (a.available === b.available) ? (a.cost - b.cost) : (a.available ? -1 : 1));
          setRewards(data);
        });
        const unsubNotifs = onSnapshot(collection(db, DATA_COLLECTION, 'notifications'), (s) => {
          const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
          data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
          if (data.length > 0 && data[0].from !== user.uid) {
            const latest = data[0];
            const isRecent = (new Date().getTime() / 1000 - (latest.timestamp?.seconds || 0)) < 30;
            if (isRecent && "Notification" in window && Notification.permission === "granted") {
              new Notification(latest.title, { body: latest.body });
            }
          }
          setNotifications(data);
          setUnreadCount(data.filter(n => !n.readBy?.includes(user.uid)).length);
        });
        return () => { unsubStats(); unsubSubs(); unsubRewards(); unsubNotifs(); };
      }, [user]);

      // äº’å‹•é‚è¼¯
      const sendNotif = async (title, body) => {
        await addDoc(collection(db, DATA_COLLECTION, 'notifications'), {
          title, body, from: user.uid, timestamp: serverTimestamp(), readBy: [user.uid]
        });
      };

      const handleUploadTask = async (e) => {
        e.preventDefault();
        if (!desc.trim() || !selectedFile) return alert("è«‹è¼¸å…¥èªªæ˜ä¸¦é™„ä¸Šç…§ç‰‡ï¼");
        setIsUploading(true);
        try {
          const img = await compressImage(selectedFile);
          await addDoc(collection(db, DATA_COLLECTION, 'submissions'), {
            description: desc, image: img, status: 'pending', timestamp: serverTimestamp(), userId: user.uid
          });
          await sendNotif("æ–°ä»»å‹™ä¸Šå‚³ï¼ğŸ“¸", `ç”·å‹å‰›æäº¤äº†ï¼š${desc}`);
          setDesc(''); setSelectedFile(null);
          alert("æäº¤æˆåŠŸï¼ç­‰å¾…å¯©æ ¸ â¤ï¸");
        } catch (e) { alert("ä¸Šå‚³å¤±æ•—"); } finally { setIsUploading(false); }
      };

      const handleApprove = async (sub) => {
        try {
          awa
